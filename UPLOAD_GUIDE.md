# ChromaDB Cloud 문서 업로드 가이드 📤

이 가이드는 `./reference` 폴더의 문서를 ChromaDB Cloud에 한 번만 업로드하는 방법을 설명합니다.

---

## 🎯 개요

### 왜 한 번만 업로드하나요?

- ✅ **효율성**: 문서 인덱싱은 시간이 오래 걸리는 작업입니다 (5-10분)
- ✅ **일관성**: 모든 챗봇 인스턴스가 동일한 데이터를 사용합니다
- ✅ **비용 절감**: OpenAI API 호출을 최소화합니다
- ✅ **클라우드 저장**: ChromaDB Cloud에 영구 저장됩니다

### 청크 설정

- **청크 크기**: 1000자
- **오버랩**: 4% (40자)
- **이유**: 청크 경계에서 문맥이 끊기는 것을 방지

---

## 📋 사전 준비

### 1. 환경 설정 확인

`.env` 파일에 다음 내용이 설정되어 있는지 확인:

```bash
# OpenAI API Key (필수)
OPENAI_API_KEY=sk-proj-...

# ChromaDB Cloud 설정 (필수)
CHROMA_API_KEY=ck-...
CHROMA_TENANT=your-tenant-id
CHROMA_DATABASE=your-database-name
CHROMA_COLLECTION=niceinfo-rules
```

### 2. 문서 준비

`./reference` 폴더에 내규 문서가 있는지 확인:

```bash
./reference/
└── [NICE평가정보]_내규 정보 모음/
    ├── 1)_조직_11/
    ├── 2)_인사_21/
    ├── 3)_복지_12/
    └── ...
```

**자동 제외**: `.zip` 파일은 자동으로 제외됩니다.

---

## 🚀 업로드 실행

### 방법: Python 스크립트 실행

```bash
python upload_to_chromadb.py
```

### 실행 과정

```
====================================================================
ChromaDB Cloud 문서 업로드 스크립트
====================================================================

✓ API 키 확인 완료
✓ ChromaDB Cloud 설정:
   - Tenant: 3464cb16-2cb7-4876-b961-af8e5c5f18c3
   - Database: niv_wjjang
   - Collection: niceinfo-rules
✓ 문서 폴더 확인 완료: .\reference

⚠️  주의: 이 작업은 ChromaDB Cloud에 문서를 업로드합니다.
   컬렉션: niceinfo-rules

계속하시겠습니까? (y/N): y

----------------------------------------------------------------------
1단계: 문서 로딩
----------------------------------------------------------------------
✓ 총 100개의 문서가 로드되었습니다.

📊 카테고리별 문서 수:
  - 조직: 15개
  - 인사: 23개
  - 복지: 12개
  ...

----------------------------------------------------------------------
2단계: ChromaDB Cloud에 업로드
----------------------------------------------------------------------
✓ ChromaDB Cloud 연결 완료
📝 청크 설정: 크기=1000자, 오버랩=40자 (4%)
⏳ 이 작업은 문서 크기에 따라 수 분이 걸릴 수 있습니다...

INFO:src.vector_store:청크 설정: size=1000, overlap=40 (4.0%)
INFO:src.vector_store:ChromaDB Cloud 클라이언트를 초기화합니다...
INFO:src.vector_store:ChromaDB Cloud 연결 완료 (Tenant: ..., DB: niv_wjjang)
INFO:src.vector_store:총 100개의 문서를 처리합니다...
INFO:src.vector_store:문서를 청크로 분할하는 중...
INFO:src.vector_store:총 1500개의 청크가 생성되었습니다.
INFO:src.vector_store:벡터 임베딩을 생성하고 저장하는 중...
INFO:src.vector_store:벡터 스토어가 ChromaDB Cloud에 생성되었습니다.

✓ ChromaDB Cloud에 업로드 완료!

----------------------------------------------------------------------
3단계: 업로드 검증
----------------------------------------------------------------------

🔍 테스트 쿼리: '직원 복무 규정'
  ✓ 결과 1: 복무규정_20250223시행.doc (유사도: 0.8523)
  ✓ 결과 2: 인사규정_20230809.doc (유사도: 0.7891)

✓ 업로드 검증 완료!

====================================================================
✅ 모든 작업이 완료되었습니다!
====================================================================

📌 다음 단계:
   1. 챗봇을 실행하세요: streamlit run app.py
   2. 챗봇은 ChromaDB Cloud의 데이터를 자동으로 로드합니다

⚠️  주의: 문서가 변경된 경우에만 이 스크립트를 다시 실행하세요
```

---

## 🔄 재업로드 (문서 변경 시)

### 언제 재업로드하나요?

다음 경우에만 재업로드가 필요합니다:

- ✅ 새로운 내규 문서가 추가된 경우
- ✅ 기존 문서 내용이 변경된 경우
- ✅ 문서가 삭제된 경우

### 재업로드 방법

```bash
python upload_to_chromadb.py
```

스크립트 실행 중 다음 질문이 나타납니다:

```
기존 컬렉션을 삭제하고 새로 생성하시겠습니까? (y/N): 
```

- **y 입력**: 기존 데이터를 완전히 삭제하고 새로 업로드
- **N 입력**: 기존 데이터에 추가 (비권장)

**권장**: 항상 `y`를 입력하여 깨끗하게 재생성하세요.

---

## 🔍 업로드 확인

### ChromaDB Cloud 대시보드에서 확인

1. ChromaDB Cloud 콘솔 접속
2. Database: `niv_wjjang` 선택
3. Collection: `niceinfo-rules` 확인
4. 문서 수 및 벡터 수 확인

### 챗봇에서 확인

```bash
streamlit run app.py
```

1. 브라우저에서 `http://localhost:8501` 접속
2. "✅ ChromaDB Cloud에서 데이터를 로드했습니다!" 메시지 확인
3. 테스트 질문: "직원 복무 규정에 대해 알려주세요"

---

## ❌ 문제 해결

### 오류: API 키가 설정되지 않음

```
❌ CHROMA_API_KEY가 설정되지 않았습니다.
```

**해결**:
1. `.env` 파일 확인
2. `CHROMA_API_KEY=...` 줄이 있는지 확인
3. 값이 올바른지 확인

### 오류: 컬렉션 로드 실패

```
❌ ChromaDB Cloud에서 데이터를 로드할 수 없습니다.
```

**해결**:
1. `python upload_to_chromadb.py` 실행
2. 문서 업로드 완료 확인
3. 챗봇 재시작

### 오류: 문서 로딩 실패

```
❌ 로드된 문서가 없습니다.
```

**해결**:
1. `./reference` 폴더 확인
2. 지원 형식 확인 (.doc, .docx, .xlsx, .pdf)
3. 파일이 손상되지 않았는지 확인

---

## 📊 통계 정보

### 예상 업로드 시간

| 문서 수 | 청크 수 (예상) | 업로드 시간 |
|---------|---------------|-------------|
| 50개    | ~750개        | 3-5분       |
| 100개   | ~1,500개      | 5-10분      |
| 200개   | ~3,000개      | 10-20분     |

### API 비용 (OpenAI)

- **임베딩 API**: text-embedding-3-small
- **비용**: 청크당 약 $0.00002
- **100개 문서 (1,500청크)**: 약 $0.03

---

## 🔒 보안 참고사항

### 데이터 전송

- ✅ OpenAI API: HTTPS 암호화 통신
- ✅ ChromaDB Cloud: HTTPS 암호화 통신
- ⚠️ 민감한 문서는 OpenAI로 전송됨

### API 키 보안

- ✅ `.env` 파일은 `.gitignore`에 포함됨
- ✅ API 키를 코드에 하드코딩하지 마세요
- ✅ 정기적으로 API 키를 교체하세요

---

## 📝 체크리스트

업로드 전:

- [ ] `.env` 파일 설정 완료
- [ ] `./reference` 폴더에 문서 준비
- [ ] OpenAI API 키 유효성 확인
- [ ] ChromaDB Cloud 접속 확인

업로드 후:

- [ ] 업로드 완료 메시지 확인
- [ ] 테스트 검색 결과 확인
- [ ] 챗봇에서 정상 로드 확인
- [ ] 테스트 질문으로 동작 확인

---

## 🆘 지원

문제가 발생하면:

1. 로그 메시지 확인
2. `.env` 파일 재확인
3. ChromaDB Cloud 대시보드 확인
4. `python check_system.py` 실행

---

**작성일**: 2025-11-11  
**버전**: 1.0

